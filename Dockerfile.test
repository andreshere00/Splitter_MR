FROM python:3.12-slim

# 1) system deps
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt-get update && apt-get install -y --no-install-recommends \
      gcc build-essential git \
    && rm -rf /var/lib/apt/lists/*

# 2) uv
RUN pip install --upgrade pip && pip install uv

WORKDIR /app

# 3) deps first
COPY pyproject.toml uv.lock ./
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system --group dev --frozen

# 4) then source (and tests, data as needed)
COPY . .

# 5) permissions & default command
RUN chmod +x ./scripts/validate_test.sh
CMD ["./scripts/validate_test.sh"]