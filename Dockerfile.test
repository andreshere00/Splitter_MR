FROM python:3.12-slim

# 1) system deps
RUN --mount=type=cache,target=/var/cache/apt \
    --mount=type=cache,target=/var/lib/apt/lists \
    apt-get update && apt-get install -y --no-install-recommends \
      gcc build-essential git \
    && rm -rf /var/lib/apt/lists/*

# 2) uv
RUN pip install --upgrade pip && pip install uv==0.6.4

WORKDIR /app

# Let setuptools_scm succeed without .git
ENV SETUPTOOLS_SCM_PRETEND_VERSION=0.0.0+test

# 3) deps first (no project yet)
COPY pyproject.toml uv.lock ./
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --group dev --frozen --no-install-project

# 4) now copy source and install the project once
COPY . .
RUN --mount=type=cache,target=/root/.cache/uv \
    uv pip install --system -e .

# 5) permissions & default command
RUN chmod +x ./scripts/validate_test.sh
CMD ["./scripts/validate_test.sh"]